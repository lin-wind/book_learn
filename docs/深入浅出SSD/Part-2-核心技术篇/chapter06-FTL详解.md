# FTL详解

---

## 6.1 FTL综述

**FTL(Flash Translation Layer，闪存转换层)** 用于完成主机逻辑地址空间到闪存物理地址空间的翻译，或者说是映射。通过实现**垃圾回收**、**磨损均衡**、**异常掉电处理**等算法，FTL 把 SSD 存储介质特性隐藏起来，使用户使用基于闪存的 SSD 像使用传统 HDD 一样，不用考虑存储介质特性。

闪存块需先擦除才能写入，不能覆盖写（out-of-place update）。当写入一笔新的数据时，不能直接在老地方直接更改（闪存不允许在一个闪存页上重复写入），必须写到一个新的位置。

```
电子：只能由 1 变 0 在物理层面上，闪存单元（Cell）默认的擦除状态是逻辑 "1"（浮栅/电荷捕获层中没有电子，或者处于低电压态）。编程（写）：实际上是向存储单元注入电子的过程。这个过程只能把状态从 1 变成 0。无法逆向：写操作无法把电子“吸出来”让 0 变回 1。想要变回 1，必须执行“擦除”操作（施加反向高压驱散电子）。

操作层面：读写操作的最小单位是页 (Page)（通常 16KB）。擦除操作的最小单位是块 (Block)（通常包含几百甚至上千个页）。
为什么不能只擦除一页？ 为了追求高密度和低成本，NAND Flash 在电路设计上，一个 Block 内的所有存储单元共用同一个基板（Substrate/P-well）。擦除时需要对基板施加高电压，这导致一通电，整个 Block 里的几百个 Page 全都被“洗白”成了 1。
```

NAND 闪存特性

- 闪存块需要先擦除才能写入，不能覆盖写
- 闪存块都是有一定寿命
- 存在读干扰问题
- 存在数据保持问题
- 存在坏块
- QLC或者TLC可以配成SLC使用

FTL 的两种实现方式：（主流SSD采用Device-Based FTL）

- Host-Based (基于主机)：FTL 算法在主机端运行，消耗计算机的 CPU 和内存资源。通常需要厂商与用户深度定制，主要用于企业级产品。
- Device-Based (基于设备)：FTL 算法在 SSD 控制器内部运行，利用 SSD 自带的 RAM 资源。核心作用：作为固件中间层，将前端主机的逻辑读写请求，转换为对后端闪存的读写请求。

![1766491474910](image/chapter06-FTL详解/1766491474910.png)

---

## 6.2 映射管理

### 6.2.1 映射的种类

FTL根据映射粒度的不同分为 **块映射**，**页映射**和**混合映射**

页映射以闪存页为映射粒度，一个逻辑页可以映射到任意一个物理页中，因此每一个页都有一个对应的映射关系。由于闪存页远比闪存块多（一个闪存块包含几百甚至几千个物理页），因此需要更多的空间来存储映射表。但它的性能更好，尤其体现在随机写上面。为追求性能，SSD 一般都采用页映射。

![1766491800163](image/chapter06-FTL详解/1766491800163.png)

- 在实际场景中，逻辑区域可能小于内存页大小，一个内存页可容纳若干个逻辑区域数据。

不同映射方式对比表

| 对比项               | 块映射 | 页映射 | 混合映射 |
| :------------------- | :----: | :----: | :------: |
| **映射单元**   | 闪存块 | 闪存页 | 块页结合 |
| **顺序写性能** |   好   |   好   |    好    |
| **顺序读性能** |   好   |   好   |    好    |
| **随机写性能** |  很差  |   好   |    差    |
| **随机读性能** |   好   |   好   |    好    |
| **映射表大小** |   小   |   大   |   一般   |

### 6.2.2 映射的基本原理



### 6.2.3 HMB



### 6.2.4 映射表写入



---

## 6.3 垃圾回收



---

## 6.4 解除映射关系

---

## 6.5 磨损均衡

---

## 6.6 掉电恢复

---

## 6.7 坏块管理

---

## 6.8 SLC缓存

---

## 6.9 读干扰和数据保持
